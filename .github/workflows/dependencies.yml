name: 🔒 Dependency Security

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run dependency check every Monday at 9 AM UTC
    - cron: "0 9 * * 1"

jobs:
  dependency-check:
    name: 🔍 Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5

      - name: 🔧 Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.5"

      - name: 📦 Download dependencies
        run: go mod download

      - name: 🔍 Run govulncheck (Official Go vulnerability scanner)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || echo "⚠️ Vulnerabilities found - check the logs above"
        continue-on-error: true # Don't fail the build, just report

      - name: 📊 Dependency Review (PR only)
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  # OSV Scanner (Google's vulnerability scanner) - more reliable alternative
  osv-scan:
    name: 🛡️ OSV Vulnerability Scan
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail the build if vulnerabilities are found

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 🔍 Run OSV Scanner
        run: |
          echo "🔍 Installing OSV Scanner..."
          curl -L https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
          echo "🔍 Running OSV Scanner..."
          ./osv-scanner -r --skip-git . || echo "OSV Scanner completed with warnings"
        continue-on-error: true
