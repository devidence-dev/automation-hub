name: ğŸ•µï¸ Security Analysis

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  secret-detection:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ TruffleHog OSS Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true # Don't fail the build

      - name: ğŸ” Basic Secret Pattern Detection
        run: |
          echo "ğŸ” Scanning for common secret patterns..."

          # Check for common secret patterns
          echo "Checking for API keys..."
          grep -r -i "api[_-]key\s*[:=]\s*['\"][^'\"]\{10,\}" . --exclude-dir=.git --exclude-dir=node_modules || echo "No API keys found"

          echo "Checking for tokens..."
          grep -r -i "token\s*[:=]\s*['\"][^'\"]\{20,\}" . --exclude-dir=.git --exclude-dir=node_modules || echo "No tokens found"

          echo "Checking for passwords..."
          grep -r -i "password\s*[:=]\s*['\"][^'\"]\{8,\}" . --exclude-dir=.git --exclude-dir=node_modules || echo "No passwords found"

          echo "âœ… Basic secret scan completed"
        continue-on-error: true

  security-analysis:
    name: ğŸš¨ Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.5"

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ” Security Analysis with go vet
        run: |
          echo "ğŸ” Running security analysis..."
          
          # Run go vet for basic issues
          go vet ./...
          
          # Additional security checks
          echo "Checking for unsafe package usage..."
          grep -r "unsafe\." . --include="*.go" || echo "âœ… No unsafe package usage found"
          
          echo "Checking for CGO usage..."
          grep -r "import \"C\"" . --include="*.go" || echo "âœ… No CGO usage found"
          
          echo "âœ… Security analysis completed"
        continue-on-error: true

      - name: ğŸ” Check for hardcoded secrets in Go code
        run: |
          echo "ğŸ” Checking for hardcoded secrets in Go files..."

          # Check for potential hardcoded secrets in Go files
          find . -name "*.go" -type f ! -path "./.git/*" -exec grep -H -n -E "(password|secret|key|token|api_key|private_key)\s*[:=]\s*[\"']" {} \; || echo "âœ… No obvious hardcoded secrets found"

          # Check for long string literals that might be secrets
          find . -name "*.go" -type f ! -path "./.git/*" -exec grep -H -n -E "[\"'][A-Za-z0-9+/]{32,}[\"']" {} \; || echo "âœ… No suspicious long strings found"
        continue-on-error: true
